# Microsoft Teams Integration

Teams æ•´åˆè®“åœ˜éšŠæˆå“¡èƒ½åœ¨ Teams ä¸­æ¥æ”¶ AWS è³‡æºç‹€æ…‹é€šçŸ¥ï¼Œç„¡éœ€ç™»å…¥ AWS Consoleã€‚

## æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Microsoft Teams                         â”‚
â”‚  Channel: airsync-dev                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ Notification
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AWS Infrastructure                      â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  EventBridge Rule: ECS/RDS State Changes            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Lambda: teams-notifier                             â”‚   â”‚
â”‚  â”‚  - Format Adaptive Card                             â”‚   â”‚
â”‚  â”‚  - POST to Teams Workflow Webhook                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DynamoDB: lights-out-teams-config                  â”‚   â”‚
â”‚  â”‚  - project â†’ webhook_url mapping                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è¨­å®šæµç¨‹

### Step 1: å»ºç«‹ Teams Workflow Webhook

1. åœ¨ Teams channel é»æ“Š `...` â†’ `Workflows`
2. æœå°‹ **"Post to a channel when a webhook request is received"**
3. é…ç½®ä¸¦å„²å­˜
4. è¤‡è£½ HTTP POST URLï¼ˆæ ¼å¼ï¼š`https://prod-XX.logic.azure.com/...`ï¼‰

### Step 2: è¨­å®š DynamoDB

```bash
# ä½¿ç”¨äº’å‹•å¼ CLI
pnpm teams

# é¸æ“‡ï¼š
# 1. Setup Database - å»ºç«‹ DynamoDB table
# 2. Add Project - æ–°å¢å°ˆæ¡ˆé…ç½®ï¼ˆè¼¸å…¥ webhook URLï¼‰
```

### Step 3: éƒ¨ç½² Lambda

```bash
pnpm deploy
# é¸æ“‡ç›®æ¨™ç’°å¢ƒ â†’ All
```

### Step 4: é©—è­‰

æ‰‹å‹•è§¸ç™¼è³‡æºç‹€æ…‹è®Šæ›´ï¼Œç¢ºèª Teams channel æ”¶åˆ°é€šçŸ¥ã€‚

```bash
# åœæ­¢ ECS service
aws ecs update-service \
  --cluster <cluster> \
  --service <service> \
  --desired-count 0

# é æœŸï¼šTeams channel æ”¶åˆ° ğŸ”´ STOPPED é€šçŸ¥
```

---

## é…ç½®èªªæ˜

### DynamoDB Schema

```json
{
  "project": "airsync-dev",
  "webhook_url": "https://prod-XX.logic.azure.com/...",
  "description": "Airsync development environment",
  "created_at": "2026-01-05T10:00:00Z"
}
```

### è³‡æº Tag å°æ‡‰

Teams é€šçŸ¥æœƒæ ¹æ“šè³‡æºçš„ tag æ‰¾åˆ°å°æ‡‰çš„å°ˆæ¡ˆé…ç½®ï¼š

```ini
lights-out:group=airsync-dev    # å°æ‡‰ DynamoDB ä¸­çš„ project
```

---

## æˆæœ¬

Teams æ•´åˆçš„ AWS æˆæœ¬å¹¾ä¹å¯å¿½ç•¥ï¼š

| æœå‹™               | ä¼°ç®—                  |
| ------------------ | --------------------- |
| Lambda invocations | ~$0.01/æœˆ             |
| DynamoDB           | ~$0.00/æœˆ (on-demand) |
| EventBridge        | å…è²»                  |
| **ç¸½è¨ˆ**           | **< $0.06/æœˆ**        |

---

## å¸¸è¦‹å•é¡Œ

### æ²’æœ‰æ”¶åˆ°é€šçŸ¥

1. ç¢ºèª Lambda æœ‰è¢«è§¸ç™¼ï¼ˆæŸ¥çœ‹ CloudWatch Logsï¼‰
2. ç¢ºèªè³‡æºæœ‰ `lights-out:group` tag
3. ç¢ºèª DynamoDB ä¸­æœ‰å°æ‡‰çš„ project é…ç½®

### Webhook URL æ´©æ¼è™•ç†

1. åœ¨ Teams Workflows ä¸­é‡æ–°ç”¢ç”Ÿ URL
2. æ›´æ–° DynamoDB é…ç½®

```bash
pnpm teams
# é¸æ“‡ Add Projectï¼ˆæœƒè¦†è“‹ç¾æœ‰é…ç½®ï¼‰
```

---

## ä¸‹ä¸€æ­¥

### Phase 2: é›™å‘æŒ‡ä»¤ï¼ˆè¦åŠƒä¸­ï¼‰

è®“ä½¿ç”¨è€…å¯åœ¨ Teams åŸ·è¡Œ start/stop/status æŒ‡ä»¤ï¼š

```
@LightsOutBot start airsync-dev
```

éœ€è¦ï¼š

- Azure Bot è¨»å†Š
- API Gateway endpoint
- teams-bot-handler Lambda

è©³è¦‹ [TODO.md](../TODO.md)
