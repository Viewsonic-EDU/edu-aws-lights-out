service: lights-out

provider:
  name: aws
  region: ap-southeast-1
  stage: ${opt:stage, 'sss-lab'}  # 對應 AWS 帳號名稱

  iam:
    role:
      statements:
        - Effect: Allow
          Action: [ssm:GetParameter]
          Resource: arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/lights-out/*
        - Effect: Allow
          Action: [tag:GetResources]
          Resource: "*"
        - Effect: Allow
          Action:
            - ecs:DescribeServices
            - ecs:UpdateService
            - ecs:ListServices
            - ecs:DescribeClusters
          Resource: "*"
        - Effect: Allow
          Action:
            - rds:DescribeDBInstances
            - rds:StartDBInstance
            - rds:StopDBInstance
          Resource: "*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

  environment:
    CONFIG_PARAMETER_NAME: /lights-out/config  # 同帳號內只有一個配置
    LOG_LEVEL: ${opt:loglevel, 'INFO'}

functions:
  lights-out:
    handler: src/index.main
    runtime: nodejs20.x
    timeout: 300
    memorySize: 512
    tags:
      project: lights-out
      managed-by: serverless

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    external: []
    target: node20
    platform: node

plugins:
  - serverless-esbuild
